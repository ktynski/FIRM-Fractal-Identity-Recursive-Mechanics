<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ex Nihilo Reality — Mathematical Figures</title>
  <link rel="stylesheet" href="assets/site.css" />
</head>
<body>
  <header class="header">
    <nav class="nav">
      <div class="brand">Ex Nihilo Reality</div>
      <a href="FIGURE_GALLERY.md">Gallery (Markdown)</a>
      <a href="#gallery">Gallery</a>
      <a href="assets/FIGURE_GALLERY.md">Assets Index</a>
      <a href="https://github.com/" target="_blank" rel="noopener">GitHub</a>
    </nav>
  </header>

  <main>
    <section class="hero">
      <div class="card">
        <h1>Mathematical Figure Library</h1>
        <p class="subtle">150 rigorously generated, provenance-tracked, publication-quality figures spanning category theory, geometry, spectral theory, topology, PDE, probability and more — all derivable from code.</p>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <a class="cta" href="#gallery">Browse Gallery</a>
          <a class="cta secondary" href="FIGURE_GALLERY.md">Markdown Index</a>
        </div>
      </div>
      <div class="card">
        <h3>Reproducible & Submission-Ready</h3>
        <ul>
          <li>Single canonical source: <code>figures/canonical_outputs/</code></li>
          <li>Manifest with hash & dimensions</li>
          <li>arXiv-ready copies prepared</li>
        </ul>
        <div class="controls">
          <div class="toolbar">
            <input class="search" id="search" placeholder="Search figure names…" />
            <select class="select" id="sort">
              <option value="name">Sort: Name</option>
              <option value="width">Sort: Width</option>
              <option value="height">Sort: Height</option>
            </select>
            <span class="badge" id="countBadge">0</span>
          </div>
          <div class="filterchips" id="chips"></div>
        </div>
      </div>
    </section>

    <section class="section" id="gallery">
      <h2>Gallery</h2>
      <div id="grid" class="grid"></div>
      <button class="btn loadmore" id="loadMore">Load More</button>
    </section>

    <section class="footer">
      <div>© Ex Nihilo Reality — All figures generated from code; see repository for provenance.</div>
    </section>
  </main>

  <script>
    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const sort = document.getElementById('sort');
    const countBadge = document.getElementById('countBadge');
    const chips = document.getElementById('chips');
    const loadMoreBtn = document.getElementById('loadMore');

    let allFigures = [];
    let visible = 0;
    const PAGE = 40;

    const TAGS = [
      'category','geometry','mathematics','pde','probability','topology','algebra','analysis','spectral','number','k_theory','lie','arithmetic','measure','operator','graphs'
    ];

    async function loadManifest() {
      const paths = [
        '../figures/peer_review/figure_manifest.json',
        'figures/peer_review/figure_manifest.json',
      ];
      for (const p of paths) {
        try {
          const res = await fetch(p);
          if (res.ok) return res.json();
        } catch (e) {}
      }
      return { figures: [] };
    }

    function canonicalUrl(entry) {
      const rel = entry.canonical_path || ('figures/canonical_outputs/' + entry.filename);
      return rel.startsWith('http') ? rel : ('../' + rel);
    }

    function inferTags(f) {
      const s = (f.filename || '').toLowerCase();
      const tags = [];
      if (s.includes('category') || s.includes('topos')) tags.push('category');
      if (s.includes('geometry') || s.includes('riemann') || s.includes('manifold')) tags.push('geometry');
      if (s.includes('pde') || s.includes('elliptic') || s.includes('heat')) tags.push('pde');
      if (s.includes('prob') || s.includes('stochastic') || s.includes('random')) tags.push('probability');
      if (s.includes('topology') || s.includes('homology') || s.includes('cohomology')) tags.push('topology');
      if (s.includes('k_theory') || s.includes('algebraic')) tags.push('algebra');
      if (s.includes('operator') || s.includes('functional')) tags.push('analysis');
      if (s.includes('spectral') || s.includes('zeta')) tags.push('spectral');
      if (s.includes('number') || s.includes('p_adic') || s.includes('modular')) tags.push('number');
      if (s.includes('lie')) tags.push('lie');
      if (s.includes('measure') || s.includes('bv')) tags.push('measure');
      if (s.includes('graph') || s.includes('graphs')) tags.push('graphs');
      return tags;
    }

    const activeTags = new Set();

    function renderChips() {
      chips.innerHTML = '';
      for (const t of TAGS) {
        const el = document.createElement('div');
        el.className = 'chip' + (activeTags.has(t) ? ' active' : '');
        el.textContent = t;
        el.onclick = () => { if (activeTags.has(t)) activeTags.delete(t); else activeTags.add(t); resetAndRender(); };
        chips.appendChild(el);
      }
    }

    function filteredSorted() {
      let q = (search.value || '').toLowerCase().trim();
      let arr = allFigures.filter(f => f.filename.toLowerCase().includes(q));
      if (activeTags.size) {
        arr = arr.filter(f => {
          const ts = inferTags(f);
          return [...activeTags].every(t => ts.includes(t));
        });
      }
      const mode = sort.value;
      if (mode === 'width') arr.sort((a,b)=> (b.width||0)-(a.width||0));
      else if (mode === 'height') arr.sort((a,b)=> (b.height||0)-(a.height||0));
      else arr.sort((a,b)=> (a.filename||'').localeCompare(b.filename||''));
      return arr;
    }

    function resetAndRender() {
      visible = 0;
      grid.innerHTML = '';
      const arr = filteredSorted();
      countBadge.textContent = arr.length;
      appendMore(arr);
    }

    function appendMore(arr) {
      const next = arr.slice(visible, visible + PAGE);
      visible += next.length;
      for (const f of next) {
        const tile = document.createElement('div');
        tile.className = 'tile';
        const img = document.createElement('img');
        img.loading = 'lazy'; img.decoding = 'async';
        img.src = canonicalUrl(f);
        img.alt = f.filename;
        const meta = document.createElement('div');
        meta.className = 'meta';
        const name = document.createElement('div'); name.className = 'name'; name.textContent = f.filename;
        const dims = document.createElement('div'); dims.className = 'dims'; dims.textContent = `${f.width||'?'}×${f.height||'?'}`;
        const actions = document.createElement('div'); actions.className = 'actions';
        const openBtn = document.createElement('a'); openBtn.className = 'btn'; openBtn.href = canonicalUrl(f); openBtn.target = '_blank'; openBtn.textContent = 'open';
        const rawBtn = document.createElement('a'); rawBtn.className = 'btn'; rawBtn.href = canonicalUrl(f); rawBtn.download = f.filename; rawBtn.textContent = 'download';
        actions.appendChild(openBtn); actions.appendChild(rawBtn);
        meta.appendChild(name); meta.appendChild(dims); meta.appendChild(actions);
        tile.appendChild(img); tile.appendChild(meta);
        grid.appendChild(tile);
      }
      loadMoreBtn.style.display = (visible < arr.length) ? 'block' : 'none';
      loadMoreBtn.onclick = () => appendMore(arr);
    }

    (async () => {
      const data = await loadManifest();
      allFigures = data.figures || [];
      renderChips();
      resetAndRender();
      search.addEventListener('input', resetAndRender);
      sort.addEventListener('change', resetAndRender);
    })();
  </script>
</body>
</html>
